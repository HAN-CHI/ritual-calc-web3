<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦®å„€æ—¥æœŸé€ŸæŸ¥å·¥å…·</title>
    
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    
    <style>
        /* æ¨£å¼ä¿æŒä¸è®Š */
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 20px; background: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        label, input, button { display: block; width: 100%; margin-bottom: 15px; font-size: 1.1em; }
        input[type="date"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #A0522D; color: white; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #8B4513; }
        #results { margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; }
        #results p { font-size: 1.1em; line-height: 1.8; border-bottom: 1px dashed #eee; padding: 5px 0; margin: 0; }
        #results span { font-weight: bold; color: #cc0000; }
        #results p:last-child { border-bottom: none; }
        .lunar-leap { color: #008080; font-weight: bold; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>äº¡è€…æ—¥æœŸè¨ˆç®—</h1>
        
        <label for="death-date">äº¡æ•…æ—¥æœŸ (åœ‹æ›†)ï¼š</label>
        <input type="date" id="death-date">

        <label for="birth-date">å‡ºç”Ÿæ—¥æœŸ (åœ‹æ›†)ï¼š</label>
        <input type="date" id="birth-date">
        
        <button id="calculate-btn">é–‹å§‹è¨ˆç®—</button>

        <div id="results">
            <h2>è¨ˆç®—çµæœ</h2>
            <p><strong>äº¡è€…è¾²æ›†ç”Ÿæ—¥ï¼š</strong> <span id="result-lunar-birth">--</span></p>
            <p>
                <strong>ç™¾æ—¥ (ç¬¬100å¤©)ï¼š</strong> 
                <span id="result-hundred-solar">--</span> (åœ‹æ›†)
                <span id="result-hundred-lunar">--</span> (è¾²æ›†)
            </p>
            <p><strong>åœ‹æ›†å°å¹´ (æ»¿ä¸€å¹´)ï¼š</strong> <span id="result-anniversary">--</span></p>
            <p><strong>è¾²æ›†å°å¹´ï¼š</strong> <span id="result-lunar-anniversary">--</span></p>
        </div>
    </div>
    
<script>
        // ğŸš¨ æœ€çµ‚è§£æ±ºæ–¹æ¡ˆï¼šæ”¹ç”¨ä¸€å€‹å° CORS é™åˆ¶æ¥µå°‘çš„è¬å¹´æ›† API
        const LUNAR_API_BASE = 'https://api.xinmeihua.com/cgi-bin/v1.1/calendar/'; 

        // æ ¼å¼åŒ– API å›å‚³çš„è¾²æ›†è³‡æ–™ (æ–° API æ ¼å¼ä¸åŒï¼Œéœ€è¦é‡å¯«)
        const formatLunar = (data) => {
            const lunarData = data.lunar;
            // è©² API çš„å¹´ä»½æ˜¯æ•¸å­—ï¼Œéœ€è¦æ‰‹å‹•è½‰æ›æˆä¸­æ–‡æ•¸å­— (ç°¡åŒ–è™•ç†)
            const yearCn = lunarData.year; 
            const isLeapText = lunarData.is_leap ? '<span class="lunar-leap">(é–)</span>' : '';
            
            return `${yearCn}å¹´ ${lunarData.month_cn}${isLeapText}æœˆ ${lunarData.day_cn}`;
        };
        
        // æ ¼å¼åŒ–ç”Ÿè‚– (æ–° API ç›´æ¥æä¾›)
        const getZodiac = (data) => {
            return data.lunar.zodiac;
        };


        // æŸ¥è©¢å–®å€‹åœ‹æ›†æ—¥æœŸçš„è¾²æ›†è³‡æ–™
        async function getLunarData(dateString) {
            const date = dayjs(dateString);
            const y = date.year();
            const m = date.month(); // month() æ˜¯ 0-11
            const d = date.date();
            
            // è©² API æ ¼å¼ç‚º: ?year=2025&month=5&day=1
            const url = `${LUNAR_API_BASE}query?year=${y}&month=${m+1}&day=${d}`;
            
            try {
                // è©² API å¿…é ˆè¨­ç½® mode=cors æ‰èƒ½åœ¨è·¨åŸŸç’°å¢ƒä¸‹å·¥ä½œ
                const response = await fetch(url, { mode: 'cors' });
                if (!response.ok) throw new Error('APIæŸ¥è©¢å¤±æ•—');
                const data = await response.json();
                
                if (data.status !== 'success' || !data.data) throw new Error('APIè¿”å›éŒ¯èª¤æ•¸æ“š');
                return data.data;
            } catch (error) {
                console.error('è¾²æ›†APIéŒ¯èª¤:', error, url);
                return null;
            }
        }

        // æŸ¥è©¢è¾²æ›†å°å¹´æ—¥æœŸ (éœ€è¦è¤‡é›œè¨ˆç®—)
        async function getLunarAnniversary(deathDateString) {
            const deathData = await getLunarData(deathDateString);
            if (!deathData) return null;

            const deathLunar = deathData.lunar;
            const targetLunarYear = parseInt(deathLunar.year) + 1;

            // API ä¸æ”¯æŒè¾²æ›†è½‰åœ‹æ›†ï¼Œæˆ‘å€‘å¿…é ˆæ‰‹å‹•æŸ¥æ‰¾æ¬¡å¹´ç›¸åŒè¾²æ›†æ—¥æœŸçš„åœ‹æ›†æ—¥æœŸã€‚
            // é€™æ˜¯æœ€è¤‡é›œä¸”å®¹æ˜“å¤±æ•—çš„ä¸€æ­¥ï¼Œä½†æˆ‘å€‘å¿…é ˆå˜—è©¦ã€‚
            
            // Step 1: é æ¸¬è¾²æ›†å°å¹´çš„åœ‹æ›†æœˆä»½
            // é è¨ˆæœƒåœ¨æ¬¡å¹´åŒä¸€åœ‹æ›†æœˆé™„è¿‘
            const deathSolar = dayjs(deathDateString);
            const targetSolarYear = deathSolar.year() + 1;
            
            // Step 2: æŸ¥æ‰¾æ¬¡å¹´åœ‹æ›†æ—¥æœŸï¼Œç›´åˆ°æ‰¾åˆ°ç›¸åŒè¾²æ›†æ—¥
            for (let m = 1; m <= 12; m++) {
                const dayInMonth = dayjs(`${targetSolarYear}-${m}-01`).daysInMonth();
                for (let d = 1; d <= dayInMonth; d++) {
                    const checkDate = dayjs(`${targetSolarYear}-${m}-${d}`);
                    const checkDateString = checkDate.format('YYYY-MM-DD');

                    const checkData = await getLunarData(checkDateString);
                    if (!checkData) continue;
                    
                    const checkLunar = checkData.lunar;

                    // æª¢æŸ¥è¾²æ›†å¹´, æœˆ, æ—¥æ˜¯å¦éƒ½åŒ¹é…
                    // æ³¨æ„ï¼šæ­¤è™•å¿½ç•¥é–æœˆç‹€æ…‹ï¼Œåªæ¯”è¼ƒå¹´æœˆæ—¥æ™‚å¦ç›¸åŒ (ç¬¦åˆè¯äººç¿’ä¿—çš„ç°¡åŒ–å°å¹´è¨ˆç®—)
                    if (
                        parseInt(checkLunar.year) === targetLunarYear &&
                        checkLunar.month === deathLunar.month && 
                        checkLunar.day === deathLunar.day
                    ) {
                        return {
                            solar: checkDate.format('YYYYå¹´MæœˆDæ—¥'),
                            lunar: checkData
                        };
                    }
                }
            }
            
            return null;
        }


        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.dayjs === 'undefined') {
                alert("ç³»çµ±éŒ¯èª¤ï¼šåŸºç¤å·¥å…·è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šï¼");
                return;
            }

            const calculateBtn = document.getElementById('calculate-btn');
            
            calculateBtn.addEventListener('click', async function() {
                const deathInput = document.getElementById('death-date').value;
                const birthInput = document.getElementById('birth-date').value;

                if (!deathInput || !birthInput) {
                    alert("è«‹è¼¸å…¥å®Œæ•´çš„æ—¥æœŸï¼");
                    return;
                }

                // é¡¯ç¤ºè¼‰å…¥ä¸­
                document.getElementById('results').querySelectorAll('span').forEach(span => {
                    span.textContent = 'æŸ¥è©¢ä¸­...';
                    span.classList.add('loading');
                });


                // --- 1. è¨ˆç®—äº¡è€…è¾²æ›†ç”Ÿæ—¥ ---
                const birthLunarData = await getLunarData(birthInput);
                if (birthLunarData) {
                    document.getElementById('result-lunar-birth').innerHTML = 
                        formatLunar(birthLunarData) + " (" + getZodiac(birthLunarData) + "å¹´)";
                } else {
                    document.getElementById('result-lunar-birth').textContent = "æŸ¥è©¢å¤±æ•—";
                }

                // --- 2. è¨ˆç®—ç™¾æ—¥ (åœ‹æ›† + è¾²æ›†) ---
                const hundred = dayjs(deathInput).add(99, 'day');
                const hundredDateString = hundred.format('YYYY-MM-DD');

                document.getElementById('result-hundred-solar').textContent = hundred.format('YYYYå¹´MæœˆDæ—¥');
                
                const hundredLunarData = await getLunarData(hundredDateString);
                if (hundredLunarData) {
                    document.getElementById('result-hundred-lunar').innerHTML = formatLunar(hundredLunarData);
                } else {
                    document.getElementById('result-hundred-lunar').textContent = "æŸ¥è©¢å¤±æ•—";
                }


                // --- 3. è¨ˆç®—åœ‹æ›†å°å¹´ ---
                const anniversary = dayjs(deathInput).add(1, 'year');
                document.getElementById('result-anniversary').textContent = anniversary.format('YYYYå¹´MæœˆDæ—¥');

                // --- 4. è¨ˆç®—è¾²æ›†å°å¹´ ---
                document.getElementById('result-lunar-anniversary').textContent = "æ­£åœ¨æŸ¥æ‰¾...";
                const anniversaryLunarData = await getLunarAnniversary(deathInput);
                if (anniversaryLunarData) {
                    document.getElementById('result-lunar-anniversary').innerHTML = 
                        anniversaryLunarData.solar + " (åœ‹æ›†) / " + 
                        formatLunar(anniversaryLunarData.lunar) + " (è¾²æ›†)";
                } else {
                    document.getElementById('result-lunar-anniversary').textContent = "ç„¡æ³•è¨ˆç®—";
                }
                
                // ç§»é™¤è¼‰å…¥ä¸­æ¨£å¼
                document.getElementById('results').querySelectorAll('span').forEach(span => {
                    span.classList.remove('loading');
                });
            });
        });
    </script>
</body>

</html>
